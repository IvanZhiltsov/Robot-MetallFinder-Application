<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Карта</title>
</head>
<body>

<script src="https://api-maps.yandex.ru/2.1/?apikey=e908d53c-26b4-4472-a88f-ecb704b3a21c&lang=ru_RU"></script>
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script>
var ymap;
var backend;

var map_type;
var map_data;

var polygon_cords = [];
var pointsCollection;
var linesCollection;
var polygonCollection;
var polygon;

var finish_cords;
var finishCollection;
var finish_point;

function del_polygon() {
	polygon_cords = [];
	pointsCollection.removeAll();
	linesCollection.removeAll();
	polygonCollection.removeAll();

	map_object = [map_type, null];
	backend.push_data(JSON.stringify(map_object));
};


<!--INIT-->
new QWebChannel(qt.webChannelTransport, async function (channel) {
	backend = await channel.objects.backend;
	init();
});

async function init() {
    map_js = await backend.get_map();
	[map_type, map_data] = await JSON.parse(map_js);

	ymaps.ready(initYMap);
};

function initYMap() {
	ymap = new ymaps.Map ('app', {
		center: [55.75, 37.61],
		zoom: 12
	});

    switch (map_type) {
    case 'empty':
        break;
    case 'edit':
        break;
    case 'data':
        break;
    };
};


<!--DRAW POLYGON-->
function start_draw_polygon() {
    pointsCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(pointsCollection);

    linesCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(linesCollection);

    polygonCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(polygonCollection);

	ymap.events.add('click', leftClick_fixMark);
	ymap.events.add('contextmenu', rightClick_fixPolygon);
};

const leftClick_fixMark = function (event) {
	let cords = event.get('coords');
	polygon_cords.push(cords);

	let placemark = new ymaps.Placemark(cords, {}, {preset: 'islands#blueCircleIcon'});
	pointsCollection.add(placemark);

    let polygon_long = polygon_cords.length
    let line;

    if (polygon_long == 2) {
        line = new ymaps.Polyline([
            polygon_cords[polygon_long - 1],
            polygon_cords[polygon_long - 2],
        ]);
        linesCollection.add(line);
	}

	else if (polygon_long == 3) {
	    line = new ymaps.Polyline([
            polygon_cords[polygon_long - 1],
            polygon_cords[polygon_long - 2],
        ]);
        linesCollection.add(line);

	    line = new ymaps.Polyline([
            polygon_cords[0],
            polygon_cords[polygon_long - 1],
        ], {}, {strokeStyle: 'dot'});
        linesCollection.add(line);
    }

    else if (polygon_long > 3) {
        linesCollection.remove();

        line = new ymaps.Polyline([
            polygon_cords[polygon_long - 1],
            polygon_cords[polygon_long - 2],
        ]);
        linesCollection.add(line);

        line = new ymaps.Polyline([
            polygon_cords[0],
            polygon_cords[polygon_long - 1],
        ], {}, {strokeStyle: 'dot'});
        linesCollection.add(line);
    };
};

const rightClick_fixPolygon = function (event) {
    if (polygon_cords.length > 2) {
	    polygon = new ymaps.Polygon([polygon_cords, []]);
	    polygonCollection.add(polygon);

	    ymap.events.remove('click', leftClick_fixMark);
	    ymap.events.remove('contextmenu', rightClick_fixPolygon);

	    let map_object = [map_type, polygon_cords, finish_cords];
	    backend.push_data(JSON.stringify(map_object));

	    backend.finish_draw();
	}

	else {
	    polygon_cords = [];
	    pointsCollection.removeAll();
	    polygon = null;
	};
	linesCollection.removeAll();
};


<!--DRAW FINISH-->
function start_draw_finish() {
    finishCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(finishCollection);

    ymap.events.add('click', leftClick_fixFinish);
	ymap.events.add('contextmenu', rightClick_delFinish);

	polygon.events.add('click', leftClick_fixFinish);
	polygon.events.add('contextmenu', rightClick_delFinish);
};

const leftClick_fixFinish = function (event) {
    let cords = event.get('coords');

    if (polygon.geometry.contains(cords)) {
        finish_cords = cords

        finish_point = new ymaps.Placemark(cords, {}, {preset: 'islands#redCircleIcon'});
	    finishCollection.add(finish_point);

        ymap.events.remove('click', leftClick_fixFinish);
	    ymap.events.remove('contextmenu', rightClick_delFinish);

	    polygon.events.remove('click', leftClick_fixFinish);
	    polygon.events.remove('contextmenu', rightClick_delFinish);

	    let map_object = [map_type, polygon_cords, null];
	    backend.push_data();

	    backend.fix_finish();
    }

    else alert('Error: cannot set finish point outside polygon');
};

const rightClick_delFinish = function (event) {
    finishCollection.removeAll();
    finishPoint = null;

    ymap.events.remove('click', leftClick_fixFinish);
	ymap.events.remove('contextmenu', rightClick_delFinish);

	polygon.events.remove('click', leftClick_fixFinish);
	polygon.events.remove('contextmenu', rightClick_delFinish);
};
</script>

<div id="app" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;">
</div>
</body>
</html>
