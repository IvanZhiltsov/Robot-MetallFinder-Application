<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Карта</title>
</head>
<body>

<script src="https://api-maps.yandex.ru/2.1/?apikey=e908d53c-26b4-4472-a88f-ecb704b3a21c&lang=ru_RU"></script>
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script>
var ymap;
var backend;

var mapType;

var polygonCords = [];
var pointsCollection;
var linesCollection;
var polygonCollection;
var polygon;

var finishCords;
var finishCollection;
var finishPoint;

var metalCords = [];
var metalCollection;


<!--BACKEND FUNCTIONS-->
function del_polygon() {
	polygonCords = [];
	pointsCollection.removeAll();
	linesCollection.removeAll();
	polygonCollection.removeAll();
	polygon = null;

	finishCollection.removeAll();
	finishPoint = null;

	let map_object = {type: mapType, data: null};
	backend.push_data(JSON.stringify(map_object));

	update_btns();
};


<!--INIT-->
new QWebChannel(qt.webChannelTransport, async function (channel) {
	backend = await channel.objects.backend;
	ymaps.ready(initYMap);
});

function initYMap() {
	ymap = new ymaps.Map ('app', {
		center: [55.75, 37.61],
		zoom: 12
	});

    createMap();
};

function createMap() {
    pointsCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(pointsCollection);

    linesCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(linesCollection);

    polygonCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(polygonCollection);

    finishCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(finishCollection);

    metalCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(metalCollection);

    update();
};


<!--UPDATE-->
async function update() {
    pointsCollection.removeAll();
    linesCollection.removeAll();
    polygonCollection.removeAll();
    finishCollection.removeAll();
    metalCollection.removeAll();

    polygon = null;
    finishPoint = null

    polygonCords = [];
    finishCords = [];
    metalCords = [];

    let map_js = await backend.get_map();
	let map_object = JSON.parse(map_js);
	let mapData
	[mapType, mapData] = Object.values(map_object);

	if (mapType != 'empty') {
        let {polygonCords: received_polygonCords,
            finishCords: received_finishCords,
            metalCords: received_metalCords} = mapData;

        if (received_polygonCords) {
            polygonCords = received_polygonCords;

            polygon = new ymaps.Polygon([polygonCords, []]);
            polygonCollection.add(polygon);

            for (let cords of polygonCords) {
                let placemark = new ymaps.Placemark(cords, {}, {preset: 'islands#blueCircleIcon'});
                pointsCollection.add(placemark);
            };
        }

        if (received_finishCords) {
            finishCords = received_finishCords;

            finishPoint = new ymaps.Placemark(cords, {}, {preset: 'islands#redCircleIcon'});
            finishCollection.add(finishPoint);
        }

        if (received_metalCords) {
            metalCords = received_metalCords;

            for (let cords of metalCords) {
                let placemark = new ymaps.Placemark(cords, {}, {preset: 'islands#yellowIcon'});
                metalCollection.add(placemark);
            };
        };
    };

    update_btns();
};

function update_btns() {
    let btns = {polygon: null, del_polygon: null, finish: null};

    if (polygon){
        btns.polygon = false;
        btns.del_polygon = true;

        if (finishPoint) btns.finish = false
        else btns.finish = true;
    }

    else {
        btns.polygon = true;
        btns.del_polygon = false;
        btns.finish = false;
    };

    backend.set_btns(JSON.stringify(btns));
};


<!--DRAW POLYGON-->
function start_draw_polygon() {
	ymap.events.add('click', leftClick_fixMark);
	ymap.events.add('contextmenu', rightClick_fixPolygon);
};

const leftClick_fixMark = function (event) {
	let cords = event.get('coords');
	polygonCords.push(cords);

	let placemark = new ymaps.Placemark(cords, {}, {preset: 'islands#blueCircleIcon'});
	pointsCollection.add(placemark);

    let polygon_long = polygonCords.length;
    let line;

    if (polygon_long == 2) {
        line = new ymaps.Polyline([
            polygonCords[polygon_long - 1],
            polygonCords[polygon_long - 2],
        ]);
        linesCollection.add(line);
	}

	else if (polygon_long == 3) {
	    line = new ymaps.Polyline([
            polygonCords[polygon_long - 1],
            polygonCords[polygon_long - 2],
        ]);
        linesCollection.add(line);

	    line = new ymaps.Polyline([
            polygonCords[0],
            polygonCords[polygon_long - 1],
        ], {}, {strokeStyle: 'dot'});
        linesCollection.add(line);
    }

    else if (polygon_long > 3) {
        linesCollection.remove();

        line = new ymaps.Polyline([
            polygonCords[polygon_long - 1],
            polygonCords[polygon_long - 2],
        ]);
        linesCollection.add(line);

        line = new ymaps.Polyline([
            polygonCords[0],
            polygonCords[polygon_long - 1],
        ], {}, {strokeStyle: 'dot'});
        linesCollection.add(line);
    };
};

const rightClick_fixPolygon = function (event) {
    if (polygonCords.length > 2) {
	    polygon = new ymaps.Polygon([polygonCords, []]);
	    polygonCollection.add(polygon);

	    ymap.events.remove('click', leftClick_fixMark);
	    ymap.events.remove('contextmenu', rightClick_fixPolygon);

	    let map_object = {type: mapType, data: {
	        polygonCords: polygonCords,
	        finishCords: null,
	        metalCords: null
	    }};
	    backend.push_data(JSON.stringify(map_object));
	}

	else {
	    polygonCords = [];
	    pointsCollection.removeAll();
	    polygon = null;
	};
	linesCollection.removeAll();

	update_btns();
};


<!--DRAW FINISH-->
function start_draw_finish() {
    ymap.events.add('click', leftClick_fixFinish);
	ymap.events.add('contextmenu', rightClick_delFinish);

	polygon.events.add('click', leftClick_fixFinish);
	polygon.events.add('contextmenu', rightClick_delFinish);
};

const leftClick_fixFinish = function (event) {
    let cords = event.get('coords');

    if (polygon.geometry.contains(cords)) {
        finishCords = cords;

        finishPoint = new ymaps.Placemark(cords, {}, {preset: 'islands#redCircleIcon'});
	    finishCollection.add(finishPoint);

        ymap.events.remove('click', leftClick_fixFinish);
	    ymap.events.remove('contextmenu', rightClick_delFinish);

	    polygon.events.remove('click', leftClick_fixFinish);
	    polygon.events.remove('contextmenu', rightClick_delFinish);

	    let map_object = {type: mapType, data: {
	        polygonCords: polygonCords,
	        finishCords: finishCords,
	        metalCords: null
	    }};
	    backend.push_data(JSON.stringify(map_object));

	    update_btns();
    }

    else alert('Error: cannot set finish point outside polygon');
};

const rightClick_delFinish = function (event) {
    finishCollection.removeAll();
    finishPoint = null;

    ymap.events.remove('click', leftClick_fixFinish);
	ymap.events.remove('contextmenu', rightClick_delFinish);

	polygon.events.remove('click', leftClick_fixFinish);
	polygon.events.remove('contextmenu', rightClick_delFinish);

	update_btns();
};
</script>

<div id="app" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;">
</div>
</body>
</html>
