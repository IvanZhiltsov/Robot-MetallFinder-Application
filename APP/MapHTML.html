<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Карта</title>
</head>
<body>

<script src="https://api-maps.yandex.ru/2.1/?apikey=e908d53c-26b4-4472-a88f-ecb704b3a21c&lang=ru_RU"></script>
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script>
var ymap;
var backend;

var map_type;
var map_data;

var polygon_cords = [];
var pointsCollection;
var linesCollection;
var polygonCollection;

function del_polygon() {
	polygon_cords = [];
	pointsCollection.removeAll();
	linesCollection.removeAll();
	polygonCollection.removeAll();
};

new QWebChannel(qt.webChannelTransport, async function (channel) {
	backend = await channel.objects.backend;
	init();
});

async function init() {
    map_js = await backend.get_map();
	[map_type, map_data] = await JSON.parse(map_js);

	ymaps.ready(initYMap);
};

function initYMap() {
	ymap = new ymaps.Map ('app', {
		center: [55.75, 37.61],
		zoom: 12
	});

    switch (map_type) {
    case 'empty':
        break;
    case 'edit':
        break;
    case 'data':
        break;
    };
};

function start_draw_polygon() {
    pointsCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(pointsCollection);

    linesCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(linesCollection);

    polygonCollection = new ymaps.GeoObjectCollection({}, {});
    ymap.geoObjects.add(polygonCollection);

	ymap.events.add('click', leftClick_fixMark);
	ymap.events.add('contextmenu', rightClick_fixPolygon);
};

const leftClick_fixMark = function (event) {
	cords = event.get('coords');
	polygon_cords.push(cords);

	let placemark = new ymaps.Placemark(cords);
	pointsCollection.add(placemark);

    let polygon_long = polygon_cords.length
    let line;

    if (polygon_long == 2) {
        line = new ymaps.Polyline([
            polygon_cords[polygon_long - 1],
            polygon_cords[polygon_long - 2],
        ]);
        linesCollection.add(line);
	}

	else if (polygon_long == 3) {
	    line = new ymaps.Polyline([
            polygon_cords[polygon_long - 1],
            polygon_cords[polygon_long - 2],
        ]);
        linesCollection.add(line);

	    line = new ymaps.Polyline([
            polygon_cords[0],
            polygon_cords[polygon_long - 1],
        ], {}, {strokeStyle: 'dot'});
        linesCollection.add(line);
    }

    else if (polygon_long > 3) {
        linesCollection.remove();

        line = new ymaps.Polyline([
            polygon_cords[polygon_long - 1],
            polygon_cords[polygon_long - 2],
        ]);
        linesCollection.add(line);

        line = new ymaps.Polyline([
            polygon_cords[0],
            polygon_cords[polygon_long - 1],
        ], {}, {strokeStyle: 'dot'});
        linesCollection.add(line);
    };
};

const rightClick_fixPolygon = function (event) {
    if (polygon_cords.length > 2) {
	    polygon = new ymaps.Polygon([polygon_cords, []], {}, {draggable: true});
	    polygonCollection.add(polygon);

	    ymap.events.remove('click', leftClick_fixMark);
	    ymap.events.remove('contextmenu', rightClick_fixPolygon);
	    backend.finish_draw();
	}

	else {
	    polygon_cords = [];
	    pointsCollection.removeAll();
	};
	linesCollection.removeAll();
};
</script>

<div id="app" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;">
</div>
</body>
</html>
